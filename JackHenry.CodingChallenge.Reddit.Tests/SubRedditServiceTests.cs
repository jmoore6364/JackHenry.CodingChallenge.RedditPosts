using Microsoft.Extensions.Logging;
using Moq;
using Newtonsoft.Json.Linq;

namespace JackHenry.CodingChallenge.Reddit.Tests
{
    [TestClass]
    public class SubRedditServiceTests
    {
        private string testData = "{\r\n    \"kind\": \"Listing\",\r\n    \"data\": {\r\n        \r\n        \"dist\": 26,\r\n        \"modhash\": null,\r\n        \"geo_filter\": null,\r\n        \"children\": [\r\n            {\r\n                \"kind\": \"t3\",\r\n                \"data\": {\r\n                    \"approved_at_utc\": null,\r\n                    \"subreddit\": \"gaming\",\r\n                    \"selftext\": \"Use this post to tell us about your YouTube Channel or Twitch stream! Show us your creativity and tell us why we should subscribe. What makes you unique?\\n\\nPlease note that this thread is NOT for selling or advertising stores. Report any such posts and we'll deal with them. Thanks!\\n\\nThis thread is posted weekly on Saturdays (adjustments made as needed).\\n\\nReminder that you must follow our [rules of promotion.](https://www.reddit.com/r/gaming/wiki/index?utm_source=reddit&amp;utm_medium=usertext&amp;utm_name=gaming&amp;utm_content=t5_2qh03#wiki_rule_7.3A_self-promotion)\",\r\n                    \"author_fullname\": \"t2_6l4z3\",\r\n                    \"saved\": false,\r\n                    \"mod_reason_title\": null,\r\n                    \"gilded\": 0,\r\n                    \"clicked\": false,\r\n                    \"title\": \"Self Promotion Saturday! Small streamer? Just getting started? Tell us about it here!\",\r\n                    \"link_flair_richtext\": [\r\n                        {\r\n                            \"e\": \"text\",\r\n                            \"t\": \"Weekly Self Promotion Thread\"\r\n                        }\r\n                    ],\r\n                    \"subreddit_name_prefixed\": \"r/gaming\",\r\n                    \"hidden\": false,\r\n                    \"pwls\": 6,\r\n                    \"link_flair_css_class\": \"sp\",\r\n                    \"downs\": 0,\r\n                    \"thumbnail_height\": null,\r\n                    \"top_awarded_type\": null,\r\n                    \"hide_score\": false,\r\n                    \"name\": \"t3_167uj51\",\r\n                    \"quarantine\": false,\r\n                    \"link_flair_text_color\": null,\r\n                    \"upvote_ratio\": 0.77,\r\n                    \"author_flair_background_color\": null,\r\n                    \"subreddit_type\": \"public\",\r\n                    \"ups\": 9,\r\n                    \"total_awards_received\": 0,\r\n                    \"media_embed\": {},\r\n                    \"thumbnail_width\": null,\r\n                    \"author_flair_template_id\": null,\r\n                    \"is_original_content\": false,\r\n                    \"user_reports\": [],\r\n                    \"secure_media\": null,\r\n                    \"is_reddit_media_domain\": false,\r\n                    \"is_meta\": false,\r\n                    \"category\": null,\r\n                    \"secure_media_embed\": {},\r\n                    \"link_flair_text\": \"Weekly Self Promotion Thread\",\r\n                    \"can_mod_post\": false,\r\n                    \"score\": 9,\r\n                    \"approved_by\": null,\r\n                    \"is_created_from_ads_ui\": false,\r\n                    \"author_premium\": true,\r\n                    \"thumbnail\": \"self\",\r\n                    \"edited\": false,\r\n                    \"author_flair_css_class\": null,\r\n                    \"author_flair_richtext\": [],\r\n                    \"gildings\": {},\r\n                    \"content_categories\": null,\r\n                    \"is_self\": true,\r\n                    \"mod_note\": null,\r\n                    \"created\": 1693634419.0,\r\n                    \"link_flair_type\": \"richtext\",\r\n                    \"wls\": 6,\r\n                    \"removed_by_category\": null,\r\n                    \"banned_by\": null,\r\n                    \"author_flair_type\": \"text\",\r\n                    \"domain\": \"self.gaming\",\r\n                    \"allow_live_comments\": false,\r\n                    \"selftext_html\": \"&lt;!-- SC_OFF --&gt;&lt;div class=\\\"md\\\"&gt;&lt;p&gt;Use this post to tell us about your YouTube Channel or Twitch stream! Show us your creativity and tell us why we should subscribe. What makes you unique?&lt;/p&gt;\\n\\n&lt;p&gt;Please note that this thread is NOT for selling or advertising stores. Report any such posts and we&amp;#39;ll deal with them. Thanks!&lt;/p&gt;\\n\\n&lt;p&gt;This thread is posted weekly on Saturdays (adjustments made as needed).&lt;/p&gt;\\n\\n&lt;p&gt;Reminder that you must follow our &lt;a href=\\\"https://www.reddit.com/r/gaming/wiki/index?utm_source=reddit&amp;amp;utm_medium=usertext&amp;amp;utm_name=gaming&amp;amp;utm_content=t5_2qh03#wiki_rule_7.3A_self-promotion\\\"&gt;rules of promotion.&lt;/a&gt;&lt;/p&gt;\\n&lt;/div&gt;&lt;!-- SC_ON --&gt;\",\r\n                    \"likes\": null,\r\n                    \"suggested_sort\": null,\r\n                    \"banned_at_utc\": null,\r\n                    \"view_count\": null,\r\n                    \"archived\": false,\r\n                    \"no_follow\": false,\r\n                    \"is_crosspostable\": true,\r\n                    \"pinned\": false,\r\n                    \"over_18\": false,\r\n                    \"all_awardings\": [],\r\n                    \"awarders\": [],\r\n                    \"media_only\": false,\r\n                    \"can_gild\": true,\r\n                    \"spoiler\": false,\r\n                    \"locked\": false,\r\n                    \"author_flair_text\": null,\r\n                    \"treatment_tags\": [],\r\n                    \"visited\": false,\r\n                    \"removed_by\": null,\r\n                    \"num_reports\": null,\r\n                    \"distinguished\": null,\r\n                    \"subreddit_id\": \"t5_2qh03\",\r\n                    \"author_is_blocked\": false,\r\n                    \"mod_reason_by\": null,\r\n                    \"removal_reason\": null,\r\n                    \"link_flair_background_color\": null,\r\n                    \"id\": \"167uj51\",\r\n                    \"is_robot_indexable\": true,\r\n                    \"report_reasons\": null,\r\n                    \"author\": \"AutoModerator\",\r\n                    \"discussion_type\": null,\r\n                    \"num_comments\": 10,\r\n                    \"send_replies\": false,\r\n                    \"whitelist_status\": \"all_ads\",\r\n                    \"contest_mode\": false,\r\n                    \"mod_reports\": [],\r\n                    \"author_patreon_flair\": false,\r\n                    \"author_flair_text_color\": null,\r\n                    \"permalink\": \"/r/gaming/comments/167uj51/self_promotion_saturday_small_streamer_just/\",\r\n                    \"parent_whitelist_status\": \"all_ads\",\r\n                    \"stickied\": true,\r\n                    \"url\": \"https://www.reddit.com/r/gaming/comments/167uj51/self_promotion_saturday_small_streamer_just/\",\r\n                    \"subreddit_subscribers\": 38070214,\r\n                    \"created_utc\": 1693634419.0,\r\n                    \"num_crossposts\": 0,\r\n                    \"media\": null,\r\n                    \"is_video\": false\r\n                }\r\n            },\r\n            {\r\n                \"kind\": \"t3\",\r\n                \"data\": {\r\n                    \"approved_at_utc\": null,\r\n                    \"subreddit\": \"gaming\",\r\n                    \"selftext\": \"\",\r\n                    \"author_fullname\": \"t2_vr890316\",\r\n                    \"saved\": false,\r\n                    \"mod_reason_title\": null,\r\n                    \"gilded\": 0,\r\n                    \"clicked\": false,\r\n                    \"title\": \"One of them should've changed their name. Still confuses me to this day.\",\r\n                    \"link_flair_richtext\": [],\r\n                    \"subreddit_name_prefixed\": \"r/gaming\",\r\n                    \"hidden\": false,\r\n                    \"pwls\": 6,\r\n                    \"link_flair_css_class\": null,\r\n                    \"downs\": 0,\r\n                    \"thumbnail_height\": 70,\r\n                    \"top_awarded_type\": null,\r\n                    \"hide_score\": false,\r\n                    \"name\": \"t3_167s5bx\",\r\n                    \"quarantine\": false,\r\n                    \"link_flair_text_color\": \"dark\",\r\n                    \"upvote_ratio\": 0.89,\r\n                    \"author_flair_background_color\": null,\r\n                    \"subreddit_type\": \"public\",\r\n                    \"ups\": 15731,\r\n                    \"total_awards_received\": 0,\r\n                    \"media_embed\": {},\r\n                    \"thumbnail_width\": 140,\r\n                    \"author_flair_template_id\": null,\r\n                    \"is_original_content\": false,\r\n                    \"user_reports\": [],\r\n                    \"secure_media\": null,\r\n                    \"is_reddit_media_domain\": true,\r\n                    \"is_meta\": false,\r\n                    \"category\": null,\r\n                    \"secure_media_embed\": {},\r\n                    \"link_flair_text\": null,\r\n                    \"can_mod_post\": false,\r\n                    \"score\": 15731,\r\n                    \"approved_by\": null,\r\n                    \"is_created_from_ads_ui\": false,\r\n                    \"author_premium\": false,\r\n                    \"thumbnail\": \"https://a.thumbs.redditmedia.com/TO5xbmMONflTza8aR9LpKyzbFHFNOo5uw-uLOtD_Fk8.jpg\",\r\n                    \"edited\": false,\r\n                    \"author_flair_css_class\": null,\r\n                    \"author_flair_richtext\": [],\r\n                    \"gildings\": {},\r\n                    \"post_hint\": \"image\",\r\n                    \"content_categories\": null,\r\n                    \"is_self\": false,\r\n                    \"mod_note\": null,\r\n                    \"created\": 1693626638.0,\r\n                    \"link_flair_type\": \"text\",\r\n                    \"wls\": 6,\r\n                    \"removed_by_category\": null,\r\n                    \"banned_by\": null,\r\n                    \"author_flair_type\": \"text\",\r\n                    \"domain\": \"i.redd.it\",\r\n                    \"allow_live_comments\": true,\r\n                    \"selftext_html\": null,\r\n                    \"likes\": null,\r\n                    \"suggested_sort\": null,\r\n                    \"banned_at_utc\": null,\r\n                    \"url_overridden_by_dest\": \"https://i.redd.it/5t9o1vaflrlb1.png\",\r\n                    \"view_count\": null,\r\n                    \"archived\": false,\r\n                    \"no_follow\": false,\r\n                    \"is_crosspostable\": true,\r\n                    \"pinned\": false,\r\n                    \"over_18\": false,\r\n                    \"preview\": {\r\n                        \"images\": [\r\n                            {\r\n                                \"source\": {\r\n                                    \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?auto=webp&amp;s=38c3523e1a6e92f3e05ee53646497a56b05644c3\",\r\n                                    \"width\": 1725,\r\n                                    \"height\": 863\r\n                                },\r\n                                \"resolutions\": [\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=108&amp;crop=smart&amp;auto=webp&amp;s=b0d4301c3beaa17d00e124b2a6ab03fc97fb83c4\",\r\n                                        \"width\": 108,\r\n                                        \"height\": 54\r\n                                    },\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=216&amp;crop=smart&amp;auto=webp&amp;s=0e719b4ff35f3703f6b88d0847dec22298ab7568\",\r\n                                        \"width\": 216,\r\n                                        \"height\": 108\r\n                                    },\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=320&amp;crop=smart&amp;auto=webp&amp;s=ee75f95a9b2242972dcb040aabfa695fa281a548\",\r\n                                        \"width\": 320,\r\n                                        \"height\": 160\r\n                                    },\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=640&amp;crop=smart&amp;auto=webp&amp;s=aa2e460c08ee1a72b9425b043e74664ce6d18779\",\r\n                                        \"width\": 640,\r\n                                        \"height\": 320\r\n                                    },\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=960&amp;crop=smart&amp;auto=webp&amp;s=be50742845b4cd18e2eb8319501f4e9a9a741e6b\",\r\n                                        \"width\": 960,\r\n                                        \"height\": 480\r\n                                    },\r\n                                    {\r\n                                        \"url\": \"https://preview.redd.it/5t9o1vaflrlb1.png?width=1080&amp;crop=smart&amp;auto=webp&amp;s=072a89101504715dd8397ab34ac1a806e6a29241\",\r\n                                        \"width\": 1080,\r\n                                        \"height\": 540\r\n                                    }\r\n                                ],\r\n                                \"variants\": {},\r\n                                \"id\": \"U5BzbjQcjUuVTi3PEEWbBXY4JUSxNTjg7L1xo7xm5tc\"\r\n                            }\r\n                        ],\r\n                        \"enabled\": true\r\n                    },\r\n                    \"all_awardings\": [],\r\n                    \"awarders\": [],\r\n                    \"media_only\": false,\r\n                    \"can_gild\": true,\r\n                    \"spoiler\": false,\r\n                    \"locked\": false,\r\n                    \"author_flair_text\": null,\r\n                    \"treatment_tags\": [],\r\n                    \"visited\": false,\r\n                    \"removed_by\": null,\r\n                    \"num_reports\": null,\r\n                    \"distinguished\": null,\r\n                    \"subreddit_id\": \"t5_2qh03\",\r\n                    \"author_is_blocked\": false,\r\n                    \"mod_reason_by\": null,\r\n                    \"removal_reason\": null,\r\n                    \"link_flair_background_color\": \"\",\r\n                    \"id\": \"167s5bx\",\r\n                    \"is_robot_indexable\": true,\r\n                    \"report_reasons\": null,\r\n                    \"author\": \"thelastfastbender\",\r\n                    \"discussion_type\": null,\r\n                    \"num_comments\": 1217,\r\n                    \"send_replies\": false,\r\n                    \"whitelist_status\": \"all_ads\",\r\n                    \"contest_mode\": false,\r\n                    \"mod_reports\": [],\r\n                    \"author_patreon_flair\": false,\r\n                    \"author_flair_text_color\": null,\r\n                    \"permalink\": \"/r/gaming/comments/167s5bx/one_of_them_shouldve_changed_their_name_still/\",\r\n                    \"parent_whitelist_status\": \"all_ads\",\r\n                    \"stickied\": false,\r\n                    \"url\": \"https://i.redd.it/5t9o1vaflrlb1.png\",\r\n                    \"subreddit_subscribers\": 38070214,\r\n                    \"created_utc\": 1693626638.0,\r\n                    \"num_crossposts\": 0,\r\n                    \"media\": null,\r\n                    \"is_video\": false\r\n                }\r\n            }\r\n        ]\r\n    }\r\n}\r\n        ";
        
        [TestMethod]
        public async Task AddPosts_AnySubReddit_AddsAllPosts()
        {
            Mock<IRedditClient> redditClientMock = new Mock<IRedditClient>();
            redditClientMock.Setup(q => q.SendAsync(It.IsAny<string>(), null, null)).ReturnsAsync(new HttpResponseMessage { Content = new StringContent(testData) });
            Mock<ISubRedditRepository> subRedditRepositoryMock = new Mock<ISubRedditRepository>();
            ISubRedditService subRedditService = new SubRedditService(redditClientMock.Object, subRedditRepositoryMock.Object, new Mock<ILogger<SubRedditService>>().Object);
            await subRedditService.AddPosts("test");
            subRedditRepositoryMock.Verify(q => q.Add(It.IsAny<JToken>()), Times.Exactly(2));
        }
    }
}
